# قرارات التصميم والافتراضات

## نظرة عامة

يوثق هذا الملف جميع قرارات التصميم الرئيسية والافتراضات التي تم اتخاذها أثناء تطوير Car Dealership API.

---

## 1. البنية المعمارية

### اختيار Clean Architecture Pattern

**القرار:** استخدام بنية معمارية واضحة مع فصل المسؤوليات.

**المبررات:**
- **قابلية الصيانة**: سهولة تعديل وتوسيع الكود
- **قابلية الاختبار**: إمكانية اختبار كل طبقة بشكل مستقل
- **الوضوح**: فهم سريع لهيكل المشروع

**الطبقات المستخدمة:**
```
Controllers/    → نقاط النهاية API
Services/       → منطق الأعمال
Models/         → نماذج البيانات
DTOs/           → كائنات نقل البيانات
Data/           → طبقة الوصول للبيانات
```

---

## 2. نظام OTP (One-Time Password)

### تطبيق OTP للعمليات الحساسة

**القرار:** حماية العمليات التالية بـ OTP:
- تسجيل الدخول
- التسجيل
- طلب الشراء
- تحديث المركبة

**المبررات:**
- **الأمان**: طبقة حماية إضافية ضد الوصول غير المصرح به
- **التحقق من الهوية**: التأكد من أن المستخدم هو من يقوم بالعملية
- **معيار صناعي**: OTP مستخدم على نطاق واسع في الأنظمة المالية

### معايير OTP

| المعيار | القيمة | المبرر |
|---------|--------|--------|
| الطول | 6 أرقام | توازن بين الأمان وسهولة الإدخال |
| الصلاحية | 5 دقائق | كافٍ للمستخدم مع الحفاظ على الأمان |
| الاستخدام | مرة واحدة | منع إعادة استخدام الرموز |
| التخزين | قاعدة البيانات | تتبع الرموز المستخدمة والمنتهية |

### محاكاة الإرسال

**القرار:** طباعة OTP في Console بدلاً من الإرسال الفعلي.

**المبررات:**
- **التطوير السريع**: لا حاجة لتكامل SMS/Email في مرحلة التطوير
- **التكلفة**: تجنب تكاليف خدمات الإرسال
- **الاختبار**: سهولة الاختبار والتصحيح

**التطبيق المستقبلي:**
```csharp
// في الإنتاج، استبدل Console.WriteLine بـ:
await _smsService.SendAsync(phoneNumber, otpCode);
// أو
await _emailService.SendAsync(email, otpCode);
```

---

## 3. المصادقة والتفويض

### اختيار JWT (JSON Web Tokens)

**القرار:** استخدام JWT للمصادقة بدلاً من Session-based authentication.

**المبررات:**
- **Stateless**: لا حاجة لتخزين الجلسات في الخادم
- **Scalability**: سهولة التوسع الأفقي
- **Cross-platform**: يعمل مع أي نوع من العملاء (Web, Mobile, Desktop)
- **معيار صناعي**: مدعوم على نطاق واسع

### إعدادات JWT

| الإعداد | القيمة | المبرر |
|---------|--------|--------|
| Algorithm | HS256 | أمان جيد وأداء عالي |
| Expiration | 24 ساعة | توازن بين الأمان وتجربة المستخدم |
| Issuer/Audience | CarDealershipAPI | التحقق من مصدر التوكن |

### Role-Based Access Control (RBAC)

**القرار:** دعم دورين فقط (Admin, Customer).

**المبررات:**
- **البساطة**: متطلبات المشروع لا تحتاج أكثر من دورين
- **الوضوح**: سهولة فهم الصلاحيات
- **القابلية للتوسع**: يمكن إضافة أدوار جديدة بسهولة

**توزيع الصلاحيات:**

| العملية | Customer | Admin |
|---------|----------|-------|
| تصفح المركبات | ✓ | ✓ |
| عرض تفاصيل مركبة | ✓ | ✓ |
| إضافة مركبة | ✗ | ✓ |
| تحديث مركبة | ✗ | ✓ |
| حذف مركبة | ✗ | ✓ |
| طلب شراء | ✓ | ✗ |
| عرض سجل المشتريات الخاص | ✓ | ✗ |
| عرض جميع المشتريات | ✗ | ✓ |
| معالجة البيع | ✗ | ✓ |
| عرض العملاء | ✗ | ✓ |

---

## 4. قاعدة البيانات

### اختيار In-Memory Database

**القرار:** استخدام Entity Framework Core In-Memory Database.

**المبررات:**
- **سرعة التطوير**: لا حاجة لإعداد قاعدة بيانات خارجية
- **سهولة الاختبار**: بيئة نظيفة في كل تشغيل
- **متطلبات المشروع**: مناسبة للتطوير والعرض التوضيحي

**القيود:**
- البيانات تُفقد عند إعادة التشغيل
- غير مناسبة للإنتاج

**الانتقال للإنتاج:**
```csharp
// استبدل في Program.cs:
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(connectionString));
// أو
    options.UseNpgsql(connectionString));
```

### تصميم قاعدة البيانات

**العلاقات:**
- User → Purchase (One-to-Many)
- Vehicle → Purchase (One-to-Many)
- OtpCode (مستقل، يُنظف دورياً)

**الفهارس (للإنتاج):**
```csharp
modelBuilder.Entity<User>()
    .HasIndex(u => u.Email)
    .IsUnique();

modelBuilder.Entity<Vehicle>()
    .HasIndex(v => v.VIN)
    .IsUnique();
```

---

## 5. أمان كلمات المرور

### اختيار SHA256 للـ Hashing

**القرار:** استخدام SHA256 لتشفير كلمات المرور.

**المبررات:**
- **البساطة**: سهل التطبيق
- **الأداء**: سريع
- **الكفاية**: مناسب لمشروع تعليمي

**ملاحظة للإنتاج:**
في بيئة الإنتاج، يُفضل استخدام خوارزميات أكثر أماناً:
```csharp
// استخدم BCrypt أو Argon2
using BCrypt.Net;

public string HashPassword(string password)
{
    return BCrypt.HashPassword(password, workFactor: 12);
}

public bool VerifyPassword(string password, string hash)
{
    return BCrypt.Verify(password, hash);
}
```

---

## 6. معالجة الأخطاء

### استراتيجية معالجة الأخطاء

**القرار:** معالجة الأخطاء على مستوى Controller مع رسائل واضحة.

**المبررات:**
- **الوضوح**: المطور يفهم الخطأ بسرعة
- **API-friendly**: رموز HTTP مناسبة
- **التصحيح**: سهولة تتبع المشاكل

**رموز HTTP المستخدمة:**
- `200 OK`: نجاح العملية
- `201 Created`: إنشاء مورد جديد
- `400 Bad Request`: خطأ في البيانات المرسلة
- `401 Unauthorized`: مصادقة مطلوبة أو فشلت
- `403 Forbidden`: ليس لديك صلاحية
- `404 Not Found`: المورد غير موجود

**التحسين المستقبلي:**
```csharp
// إضافة Global Exception Handler
app.UseExceptionHandler("/error");

// أو Middleware مخصص
public class ErrorHandlingMiddleware
{
    // معالجة جميع الاستثناءات بشكل موحد
}
```

---

## 7. التحقق من المدخلات

### Input Validation Strategy

**القرار:** التحقق الأساسي في Controllers + Data Annotations.

**المبررات:**
- **الأمان**: منع SQL Injection و XSS
- **جودة البيانات**: ضمان صحة البيانات المخزنة
- **تجربة المستخدم**: رسائل خطأ واضحة

**أمثلة:**
```csharp
// في DTOs
[Required]
[EmailAddress]
public string Email { get; set; }

[Required]
[StringLength(100, MinimumLength = 6)]
public string Password { get; set; }

// في Controllers
if (string.IsNullOrWhiteSpace(request.Email))
{
    return BadRequest(new { message = "Email is required" });
}
```

**التحسين المستقبلي:**
- استخدام FluentValidation
- Input Sanitization شامل
- Rate Limiting

---

## 8. توثيق API

### اختيار Swagger/OpenAPI

**القرار:** استخدام Swagger لتوثيق API بشكل تفاعلي.

**المبررات:**
- **التفاعلية**: اختبار نقاط النهاية مباشرة
- **التوليد التلقائي**: توثيق يُحدث تلقائياً
- **معيار صناعي**: OpenAPI specification
- **دعم JWT**: إمكانية المصادقة من الواجهة

**الإعدادات:**
```csharp
builder.Services.AddSwaggerGen(options =>
{
    options.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "Car Dealership API",
        Version = "v1",
        Description = "..."
    });
    
    // JWT support
    options.AddSecurityDefinition("Bearer", ...);
});
```

---

## 9. البيانات النموذجية (Seed Data)

### استراتيجية Seeding

**القرار:** تحميل بيانات نموذجية تلقائياً عند بدء التطبيق.

**المبررات:**
- **سهولة الاختبار**: بيانات جاهزة للاختبار الفوري
- **العرض التوضيحي**: إظهار إمكانيات النظام
- **التطوير**: بيئة متسقة لجميع المطورين

**البيانات المحملة:**
- 1 Admin user
- 1 Customer user
- 10 Vehicles

**الكود:**
```csharp
// في Program.cs
using (var scope = app.Services.CreateScope())
{
    var context = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
    await SeedData(context, passwordService);
}
```

---

## 10. الأداء والتحسين

### استراتيجيات الأداء المطبقة

1. **Async/Await**: جميع عمليات I/O غير متزامنة
2. **LINQ Optimization**: استعلامات فعالة
3. **Projection**: استخدام Select لتقليل البيانات المنقولة
4. **Include**: تحميل العلاقات بكفاءة

**أمثلة:**
```csharp
// بدلاً من
var purchases = await _context.Purchases.ToListAsync();

// استخدم
var purchases = await _context.Purchases
    .Include(p => p.Vehicle)
    .Select(p => new PurchaseDto { ... })
    .ToListAsync();
```

### التحسينات المستقبلية

1. **Caching**: Redis للبيانات المتكررة
2. **Pagination**: تقسيم النتائج الكبيرة
3. **Response Compression**: ضغط الاستجابات
4. **Database Indexing**: فهارس للاستعلامات الشائعة

---

## 11. الافتراضات

### افتراضات الأعمال

1. **عملية الشراء:**
   - العميل يطلب الشراء → المدير يعالج الطلب
   - لا يوجد دفع فعلي (خارج النطاق)
   - المركبة تصبح غير متاحة عند إتمام البيع

2. **إدارة المخزون:**
   - المدير فقط يمكنه إضافة/تعديل/حذف المركبات
   - VIN فريد لكل مركبة
   - المركبة إما متاحة أو غير متاحة (لا حالات وسطى)

3. **المستخدمين:**
   - البريد الإلكتروني فريد لكل مستخدم
   - لا يمكن تغيير الدور بعد التسجيل
   - لا يوجد نظام لاستعادة كلمة المرور (يمكن إضافته)

### افتراضات تقنية

1. **البيئة:**
   - التطبيق يعمل في بيئة موثوقة
   - لا حاجة لـ HTTPS في التطوير
   - Console output كافٍ لـ OTP

2. **الحجم:**
   - عدد المستخدمين محدود
   - عدد المركبات معقول (< 10,000)
   - لا حاجة لـ Pagination حالياً

3. **الأمان:**
   - CORS مفتوح للتطوير
   - JWT secret ثابت (في الإنتاج، استخدم متغيرات البيئة)
   - لا Rate Limiting (يجب إضافته للإنتاج)

---

## 12. القيود المعروفة

### قيود تقنية

1. **In-Memory Database**: البيانات تُفقد عند إعادة التشغيل
2. **Single Instance**: لا دعم للتوزيع
3. **No File Upload**: لا يمكن رفع صور المركبات
4. **No Email/SMS**: محاكاة OTP فقط

### قيود الأعمال

1. **No Payment**: لا تكامل مع بوابات الدفع
2. **No Inventory Tracking**: لا تتبع لتاريخ المركبة
3. **No Notifications**: لا إشعارات للمستخدمين
4. **No Multi-language**: اللغة الإنجليزية فقط في الكود

---

## 13. خارطة الطريق المستقبلية

### المرحلة 1: الأساسيات (مكتملة ✓)
- [x] نظام المصادقة مع OTP
- [x] إدارة المركبات
- [x] إدارة المشتريات
- [x] Role-based access
- [x] Swagger documentation

### المرحلة 2: التحسينات (مقترحة)
- [ ] قاعدة بيانات دائمة (SQL Server/PostgreSQL)
- [ ] تكامل SMS/Email فعلي
- [ ] Logging شامل (Serilog)
- [ ] Unit Tests
- [ ] Docker containerization

### المرحلة 3: المميزات المتقدمة (مستقبلية)
- [ ] رفع صور المركبات
- [ ] نظام التقييمات والمراجعات
- [ ] نظام الإشعارات
- [ ] تقارير وإحصائيات
- [ ] تكامل مع بوابات الدفع
- [ ] Mobile app

---

## الخلاصة

تم اتخاذ جميع قرارات التصميم بناءً على:
1. **متطلبات المشروع**: تلبية جميع المتطلبات الأساسية
2. **أفضل الممارسات**: اتباع معايير الصناعة
3. **البساطة**: كود واضح وسهل الفهم
4. **القابلية للتوسع**: إمكانية إضافة مميزات جديدة
5. **الأمان**: حماية البيانات والعمليات الحساسة

النظام جاهز للاستخدام في بيئة التطوير والعرض التوضيحي، مع وضوح في المسار للانتقال إلى بيئة الإنتاج.
